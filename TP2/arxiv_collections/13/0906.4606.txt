A practical finite temperature theory is developed for the superfluid regime
of a weakly interacting Bose gas in an optical lattice with additional harmonic
confinement. We derive an extended Bose-Hubbard model that is valid for shallow
lattices and when excited bands are occupied. Using the
Hartree-Fock-Bogoliubov-Popov mean-field approach, and applying local density
and coarse-grained envelope approximations, we arrive at a theory that can be
numerically implemented accurately and efficiently. We present results for a
three-dimensional system, characterizing the importance of the features of the
extended Bose-Hubbard model and compare against other theoretical results and
show an improved agreement with experimental data.